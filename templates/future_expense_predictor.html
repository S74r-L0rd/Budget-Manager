{% extends "layout_user.html" %}
{% block title %}Future Expense Predictor{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis_tools.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis.css') }}">
{% endblock %}

{% block content %}
<div class="main-content-with-navbar">
    <section class="expense-tracker-section">
        <div class="expense-tracker-box">
          <h2>Future Expense Predictor</h2>
          <p class="mt-4 mb-5">
            Upload your past expenses in <strong>Excel Format</strong> to forecast upcoming monthly trends using AI models.
            Please ensure the file follows the required structure in this order for accurate analysis.
          </p>

          <div class="template-guidelines mb-4">
            <strong>ðŸ“‹ Required Template Format:</strong>
            <ul class="template-fields mt-2">
              <li><code>Date</code></li>
              <li><code>Category</code></li>
              <li><code>Description</code></li>
              <li><code>Amount</code></li>
              <li><code>Payment Method</code></li>
            </ul>
            <p class="mt-5">
              If you donâ€™t already have the template, you can download it below, fill it in, and upload it back here.
            </p>
          </div>
      
          <!-- Download Template -->
          <a href="{{ url_for('download_template') }}" class="btn-primary">â¬‡ Download Excel Template</a>
      
          <!-- Upload Form -->
          <form action="{{ url_for('upload_expenses') }}" method="POST" enctype="multipart/form-data" class="upload-form">
            <label for="file">Upload Filled Template</label>
            <input type="file" name="file" id="file" accept=".xlsx" required>
            <button type="submit" class="btn-secondary">ðŸ”® Predict Future</button>
          </form>
        </div>

        {% if show_results %}
        <div class="container mt-5">
            <h4 class="mb-4">Predicted Expense Trend</h4>

            {% if summary %}
                <div class="alert alert-info text-center fs-5 fw-semibold my-4">
                    {{ summary }}
                </div>
            {% endif %}
            
            <div class="chart-section">
                {{ chart | safe }}
            </div>

            <div class="mt-4 text-center">
                <button class="tool-button" data-bs-toggle="modal" data-bs-target="#shareModal">
                ðŸ“¤ Share This Analysis
                </button>
            </div>
        </div>
        {% endif %}

        <div class="container pt-6">
            <!-- Shared by Me -->
            <h4 class="text-success mb-3 pt-6">Shared by Me</h4>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5">
                {% for share in shared_by_me %}
                <div class="col">
                    <div class="shared-card shared-by-me-card">
                        <h5>Future Expense Predictor</h5>
                        <p><strong>Shared With:</strong> {{ share.shared_user.name }}</p>
                        <p><strong>Date:</strong> {{ share.created_at.strftime('%Y-%m-%d') if share.created_at else "N/A" }}</p>
                        <p class="small text-muted">Predicted using uploaded expense history.</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Shared with Me -->
            <h4 class="text-info mb-3 pt-6">Shared with Me</h4>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 pb-5">
                {% for share in shared_with_me %}
                <div class="col">
                    <div class="shared-card shared-with-me-card">
                        <h5>Future Expense Predictor</h5>
                        <p><strong>Shared By:</strong> {{ share.goal.owner.name }}</p>
                        <p><strong>Date:</strong> {{ share.created_at.strftime('%Y-%m-%d') if share.created_at else "N/A" }}</p>
                        <p class="small text-muted">Explore trends shared with you for review.</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <div style="display: flex; justify-content: center;" class="my-4">
      <a href="{{ url_for('analysis') }}" class="tool-button">â¬… Back to Toolkit</a>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" action="{{ url_for('share_future_prediction') }}">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="shareModalLabel">Share Analysis</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Select users you want to share this analysis with:</p>
            <div class="form-group">
              <select name="share_with[]" multiple class="form-control" size="8" required>
                {% for user in users %}
                  <option value="{{ user.id }}">{{ user.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Share</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
</div>

{% endblock %}